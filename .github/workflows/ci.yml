name: CI

on:
  workflow_call:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Cache shards
        uses: actions/cache@v4
        with:
          path: |
            lib
            ~/.cache/shards
          key: ${{ runner.os }}-shards-${{ hashFiles('shard.lock') }}
          restore-keys: |
            ${{ runner.os }}-shards-

      - name: Install dependencies
        run: shards install

      - name: Check formatting
        run: crystal tool format --check

      - name: Run tests
        run: crystal spec

  build-binaries:
    name: Build ralph-${{ matrix.os }}-${{ matrix.arch }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
            alpine_image: amd64/alpine
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
            alpine_image: arm64v8/alpine
          - os: darwin
            arch: amd64
            runner: macos-13
          - os: darwin
            arch: arm64
            runner: macos-14
          - os: windows
            arch: amd64
            runner: windows-2022

    runs-on: ${{ matrix.runner }}
    env:
      FILENAME: ralph-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build (Linux)
        if: matrix.os == 'linux'
        run: |
          docker run --rm -v "${{ github.workspace }}:/workspace" -w /workspace ${{ matrix.alpine_image }} sh -c '
            apk update &&
            apk add --no-cache \
              crystal shards \
              gcc musl-dev \
              openssl-dev openssl-libs-static \
              sqlite-dev sqlite-static \
              yaml-static zlib-static \
              pcre2-dev pcre2-static \
              gc-dev gc-static \
              libevent-dev libevent-static \
              libpq-dev \
              make git &&
            shards install --shard-file=shard.cli.yml &&
            crystal build src/bin/ralph.cr -o ralph --release --static &&
            cp ralph ${{ env.FILENAME }}
          '

      - name: Install Crystal (macOS)
        if: matrix.os == 'darwin'
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Build (macOS)
        if: matrix.os == 'darwin'
        run: |
          brew install openssl@3 libpq sqlite
          brew unlink openssl@1.1 || true
          brew link --force --overwrite openssl@3

          export PATH="/opt/homebrew/opt/openssl@3/bin:/usr/local/opt/openssl@3/bin:$PATH"
          export LDFLAGS="-L/opt/homebrew/opt/openssl@3/lib -L/usr/local/opt/openssl@3/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/openssl@3/include -I/usr/local/opt/openssl@3/include"
          export PKG_CONFIG_PATH="/opt/homebrew/opt/openssl@3/lib/pkgconfig:/usr/local/opt/openssl@3/lib/pkgconfig"

          shards install --shard-file=shard.cli.yml
          crystal build src/bin/ralph.cr -o ralph --release
          cp ralph ${{ env.FILENAME }}

      - name: Install Crystal (Windows)
        if: matrix.os == 'windows'
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Build (Windows)
        if: matrix.os == 'windows'
        run: |
          shards install --shard-file=shard.cli.yml
          crystal build src/bin/ralph.cr -o ralph.exe --release
          Copy-Item "ralph.exe" "${{ env.FILENAME }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILENAME }}
          path: ${{ env.FILENAME }}
          retention-days: 45
